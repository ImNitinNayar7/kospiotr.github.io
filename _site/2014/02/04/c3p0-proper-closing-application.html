<!DOCTYPE html>
<html lang="en">
  <head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="">
	<meta name="author" content="Piotr Kosmowski">
	<link rel="shortcut icon" href="favicon.ico">

	<title>Piotr Kosmowski page</title>

	<!-- Fonts -->
	<link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro%3A400%2C400italic%2C700" rel="stylesheet">
	<link href="http://fonts.googleapis.com/css?family=Varela+Round" rel="stylesheet">

	<!-- Bootstrap core CSS -->
	<link href="/css/bootstrap.min.css" rel="stylesheet">
	<link href="/css/font-awesome.min.css" rel="stylesheet">
	<link href="/css/bootstrap-social.css" rel="stylesheet">

	<!-- Styles -->
	<link href="/css/main.css" rel="stylesheet">

	<!-- Loading bar -->
	<script src="/js/jquery-1.10.2.min.js"></script>
	<script src="/js/jquery.stoc.js"></script>
	

	
	<!-- HTML5 shiv for IE8 support -->
	<!--[if lt IE 9]>
	  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
	<![endif]-->
  </head>

  <body>
	

	<section id="sidebar" class="col-sm-3 sidebar" style="display: inline-block;">
<header id="header">
	<a href="/">
	<img src="http://www.gravatar.com/avatar/a4e3f3d974bfdd573f2bb607617b82c1.png" alt="Piotr Kosmowski" id="gravatar"/>
	<p id="author-full-name">Piotr Kosmowski</p>
	<p id="slogan">Hi, I'm Piotr and I write code for food.</p>
</a>
</header>
<nav id="navigation">
	<div class="row">
		<a href="http://twitter.com/kospiotr" class="btn btn-default">Twitter</a>
		<a href="http://pl.linkedin.com/pub/piotr-kosmowski/25/379/467" class="btn btn-default">LinkedIn</a>
		<a href="/blog" class="btn btn-default">Blog</a>
	</div>
	<div class="row">	
		<a href="http://github.com/kospiotr" class="btn btn-default">Github</a>
		<a href="/wiki" class="btn btn-default">Wiki</a>
	</div>
</nav>
	</section>

	<section id="main" class="col-sm-9">
		<div id="main-container">
<article id="main-article">
	<header id="header">
		<nav id="nav">
			
				<a href="/2014/02/03/hiberante-with-guice.html" title="Older: Hibernate + Guice" class="btn btn-default">←</a>
			
				<a href="/blog" class="btn btn-default">Blog posts</a>
			
				<a href="/2014/02/05/own-maven-repository-on-google-code.html" title="Newer: Prywatne repozytorium Maven na code.google.pl" class="btn btn-default">→</a>
			
		</nav>
		<h1 id="page-title">C3P0 - poprawne zamykanie</h1>
		
			<h2 id="page-description">
				Naprawa zamykania puli (in Polish)
			</h2>
		
		<h3> 04 Feb 2014</h3>
	</header>
	<div id="article-body" class="markdown-body">

<p>W przypadku, gdy aplikacja do przechowywania danych wykorzystuje relacyjną bazę danych bardzo często się zdarza, że korzysta z takich narzędzi wspomagających jak Hibernate czy MyBatis (określenie “narzędzie” jest tu celowe, ponieważ najczęściej o tej warstwie mówi się skrótowo ORM, przy czym MyBatis ORM-em nie jest).</p>

<p>Biblioteki te (jak i również inne) mogą wykorzystywać zewnętrzne mechanizmy transakcji, czy zarządzania źródłami danych i tu zmierzam do C3P0.</p>

<p>C3p0 jest biblioteką, która wnosi warstwę obsługi wielu połączeń z bazą danych. W skrócie: gdy klient/usługa chce pobrać dane z bazy połączenie z bazą danych zostaje zajęte przez sesję klienta, które zwalniane jest dopiero po przetworzeniu i zwróceniu wyników. W przypadku, gdy wielu klientów chce naraz pobrać dane jeden użytkownik okupuje połączenie a pozostali czekają w kolejce dopóki się nie zwolni. Biorąc pod uwagę skalę, czyli duża ilość użytkowników korzysta z aplikacji, która wykonuje skomplikowane, powolne zapytania na dużej bazie danych może to być niewątpliwie spory problem.</p>

<p>C3P0 pozwala na wprowadzenie większej ilości niezależnych połączeń do bazy – taka wielowątkowość dla wątków :-).</p>

<p>Więcej informacji na ten temat można znaleźć na stronie projektu: http://sourceforge.net/projects/c3p0/ bądź na stronach bibliotek wykorzystujących C3P0.</p>

<p>Dzisiaj jednak zgodnie z tytułem zajmiemy się problemem, który może stanowić o stabilnej pracy naszej aplikacji. Gdy już przekonamy się do korzystania z biblioteki problem pojawia się podczas undeployingu na bazie Tomcat. Biblioteka nie zamyka i wyrejestrowuje nawiązanych połączeń. Podczas próby ponownego umieszczenia projektu na serwerze mogą pojawić się problemy, ponieważ niektóre klasy pozostają w pamięci. W ostateczności może nie dojść do poprawnego umieszczenia aplikacji. Od wersji 6.9 Tomcata została zaaplikowana usługa retrospekcji dla wybranych klas, co pozwala wyrejestrować je automatycznie przez kontener, ale z doświadczenia zauważyłem, że nie dzieje się to za każdym razem. Rozwiązaniem może być ręczne pozamykanie połączeń, które wywołamy w momencie gdy serwer jest zatrzymywany. Służy do tego listener który dodajemy w web.xml:</p>
<div class="highlight"><pre><code class="xml language-xml" data-lang="xml"><span class="nt">&lt;listener&gt;</span>
    <span class="nt">&lt;listener-class&gt;</span>pl.xperios.rdk.server.startup.ServerStarter<span class="nt">&lt;/listener-class&gt;</span>
<span class="nt">&lt;/listener&gt;</span>
</code></pre></div>
<p>Poniżej znajduje się implementacja zamykania wszystkich połączeń dla C3p0, którą należy umieścić w listenerze Tomcata. Przykład:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">MainServerModuleManager</span> <span class="kd">implements</span> <span class="n">EventListener</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">contextInitialized</span><span class="o">(</span><span class="n">ServletContextEvent</span> <span class="n">servletContextEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">contextDestroyed</span><span class="o">(</span><span class="n">ServletContextEvent</span> <span class="n">servletContextEvent</span><span class="o">)</span> <span class="o">{</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">connection</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">dataSource</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">DataSources</span><span class="o">.</span><span class="na">destroy</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
                    <span class="n">dataSource</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">sQLException</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

	</div>
	<nav id="nav-bottom">
		
			<a href="/2014/02/03/hiberante-with-guice.html" title="Older: Hibernate + Guice" class="btn btn-default">←</a>
		
			<a href="/blog" class="btn btn-default">Blog posts</a>
		
			<a href="/2014/02/05/own-maven-repository-on-google-code.html" title="Newer: Prywatne repozytorium Maven na code.google.pl" class="btn btn-default">→</a>
		
	</nav>

	<footer id="comments">
		<header>
			<h1>Comments</h1>
		</header>
		<div id="disqus_thread"></div>
		<script type="text/javascript">
			var disqus_shortname = 'piotr-kosmowski-site'; // required: replace example with your forum shortname

			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>
		<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	</footer>

</article>
﻿<footer class="footer">
	<p>© Piotr Kosmowski. All right reserved. </p>
</footer>
		</div>
	</section>
  </body>
</html>