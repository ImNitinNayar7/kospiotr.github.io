<!DOCTYPE html>
<html lang="en">
  <head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="">
	<meta name="author" content="Piotr Kosmowski">
	<link rel="shortcut icon" href="favicon.ico">

	<title>Piotr Kosmowski page</title>

	<!-- Fonts -->
	<link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro%3A400%2C400italic%2C700" rel="stylesheet">
	<link href="http://fonts.googleapis.com/css?family=Varela+Round" rel="stylesheet">

	<!-- Bootstrap core CSS -->
	<link href="/css/bootstrap.min.css" rel="stylesheet">
	<link href="/css/font-awesome.min.css" rel="stylesheet">
	<link href="/css/bootstrap-social.css" rel="stylesheet">

	<!-- Styles -->
	<link href="/css/main.css" rel="stylesheet">

	<!-- Loading bar -->
	<script src="/js/jquery-1.10.2.min.js"></script>
	<script src="/js/jquery.stoc.js"></script>
	

	
	<!-- HTML5 shiv for IE8 support -->
	<!--[if lt IE 9]>
	  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
	<![endif]-->
  </head>

  <body>
	

	<section id="sidebar" class="col-sm-3 sidebar" style="display: inline-block;">
<header id="header">
	<a href="/">
	<img src="http://www.gravatar.com/avatar/a4e3f3d974bfdd573f2bb607617b82c1.png" alt="Piotr Kosmowski" id="gravatar"/>
	<p id="author-full-name">Piotr Kosmowski</p>
	<p id="slogan">Hi, I'm Piotr and I write code for food.</p>
</a>
</header>
<nav id="navigation">
	<div class="row">
		<a href="http://twitter.com/kospiotr" class="btn btn-default">Twitter</a>
		<a href="http://pl.linkedin.com/pub/piotr-kosmowski/25/379/467" class="btn btn-default">LinkedIn</a>
		<a href="/blog" class="btn btn-default">Blog</a>
	</div>
	<div class="row">	
		<a href="http://github.com/kospiotr" class="btn btn-default">Github</a>
		<a href="/wiki" class="btn btn-default">Wiki</a>
	</div>
</nav>
	</section>

	<section id="main" class="col-sm-9">
		<div id="main-container">
<article id="main-article">
	<header id="header">
		<nav id="nav">
			
				<a href="/2014/02/01/gwt-basic-components.html" title="Older: Google Web Toolkit" class="btn btn-default">←</a>
			
				<a href="/blog" class="btn btn-default">Blog posts</a>
			
				<a href="/2014/02/03/hiberante-with-guice.html" title="Newer: Hibernate + Guice" class="btn btn-default">→</a>
			
		</nav>
		<h1 id="page-title">Google Web Toolkit + Guice</h1>
		
			<h2 id="page-description">
				Instalacja, konfiguracja oraz zestawienie z Google Web Toolkit (in Polish)
			</h2>
		
		<h3> 02 Feb 2014</h3>
	</header>
	<div id="article-body" class="markdown-body">

<p>Guice jest frameworkiem dostarczającym tzn. wstrzykiwania zależności w naszej części serwerowej aplikacji.
Gdybyśmy rozważali aplikację typu desktop poniższa konfiguracja w zupełności by wystarczyła:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kn">package</span> <span class="n">testingguice</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.google.inject.AbstractModule</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.inject.Guice</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.inject.Injector</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Injector</span> <span class="n">injector</span> <span class="o">=</span> <span class="n">Guice</span><span class="o">.</span><span class="na">createInjector</span><span class="o">(</span><span class="k">new</span> <span class="n">MyModule</span><span class="o">());</span>
        <span class="n">PersonDao</span> <span class="n">personDao</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">PersonDao</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Person</span> <span class="n">person</span> <span class="o">:</span> <span class="n">personDao</span><span class="o">.</span><span class="na">getAll</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Person: &quot;</span><span class="o">+</span><span class="n">person</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>Klasa modułu w rozumieniu IoC:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyModule</span> <span class="kd">extends</span> <span class="n">AbstractModule</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">bind</span><span class="o">(</span><span class="n">PersonDao</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">PersonDaoImpl</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>Interfejs przykładowego DAO dla klasy Person:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PersonDao</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="nf">getAll</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div>
<p>Implementacja naszego interfejsu, którą dzięki IoC możemy w łatwy sposób podmienić na inną implementującą ten sam interfejs:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PersonDaoImpl</span> <span class="kd">implements</span> <span class="n">PersonDao</span><span class="o">{</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="nf">getAll</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;();</span>
        <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">&quot;Jacek&quot;</span><span class="o">));</span>
        <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="s">&quot;Zbyszek&quot;</span><span class="o">));</span>
        <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="s">&quot;Piotrek&quot;</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">list</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>Przykładowe POJO wykorzystywane w DAO:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Person</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">Person</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="o">...</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;Person{&quot;</span> <span class="o">+</span> <span class="s">&quot;id=&quot;</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span> <span class="s">&quot;,name=&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="sc">&#39;}&#39;</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>
<p>My jednak korzystamy z aplikacji JEE, z którą nie jest aż tak łatwo. Aplikacja, która jest deployowana na serwer przed pierwszym wywołaniem strony ładującej powinna zostać zainicjonowana, co zostało zrobione w przypadku aplikacji desktopowej tu:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="n">Injector</span> <span class="n">injector</span> <span class="o">=</span> <span class="n">Guice</span><span class="o">.</span><span class="na">createInjector</span><span class="o">(</span><span class="k">new</span> <span class="n">MyModule</span><span class="o">());</span>
</code></pre></div>
<p>W aplikacji typu web za pomocą małego wpisu w web.xml:</p>
<div class="highlight"><pre><code class="xml language-xml" data-lang="xml"><span class="nt">&lt;listener&gt;</span>
  <span class="nt">&lt;listener-class&gt;</span>pl.testing.server.GuiceServletConfig<span class="nt">&lt;/listener-class&gt;</span>
<span class="nt">&lt;/listener&gt;</span>
</code></pre></div>
<p>sprawiamy, że zaraz po zdeployowaniu aplikacji zostanie od razu wywołana wskazana klasa dziedzicząca po ContextListener. Wykorzystamy ten fakt do zainicjonowania naszego injectora. W tym przypadku będziemy posiłkować się dodatkowo klasą GuiceServletContextListener, która wspomaga nas i odciąża tak, że wszystko co musimy zrobić to zwrócić injector:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainGuiceServletContextListener</span> <span class="kd">extends</span> <span class="n">GuiceServletContextListener</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">Injector</span> <span class="nf">getInjector</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Guice</span><span class="o">.</span><span class="na">createInjector</span><span class="o">(</span><span class="k">new</span> <span class="n">MainGuiceModule</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>Resztą tzn. pobieraniem instancji z injectora zajmie się specjalnie przygotowany przez nas w web.xml filtr:</p>
<div class="highlight"><pre><code class="xml language-xml" data-lang="xml">  <span class="nt">&lt;filter&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>guiceFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;filter-class&gt;</span>com.google.inject.servlet.GuiceFilter<span class="nt">&lt;/filter-class&gt;</span>
  <span class="nt">&lt;/filter&gt;</span>

  <span class="nt">&lt;filter-mapping&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>guiceFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
  <span class="nt">&lt;/filter-mapping&gt;</span>
</code></pre></div>
<p>Jest to następna sztuczka wykorzystywana przez Guice’a. Gdybyśmy nie wykorzystali filtra każdorazowo gdy żądamy zawartości serwleta zostałaby stworzona instancja serwleta uruchomiona i zwrócony efekt jego przetwarzania. Natomiast wykorzystując filtr jesteśmy w stanie do wybranych (najczęściej dla wszystkich) serwletów wstrzyknąć odpowiednie zależności konfiguracyjne.</p>

<p>Konfigurując moduł w następujący sposób mapujemy wywołanie adresu: /examplexmlrpc z ExampleRpcImpl.class:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GuiceModule</span> <span class="kd">extends</span> <span class="n">ServletModule</span><span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configureServlets</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">configureServlets</span><span class="o">();</span>
        <span class="n">serve</span><span class="o">(</span><span class="s">&quot;/examplerpc&quot;</span><span class="o">).</span><span class="na">with</span><span class="o">(</span><span class="n">ExampleRpcImpl</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>Jest to dokładnie odpowiednik wpisu w web.xml:</p>
<div class="highlight"><pre><code class="xml language-xml" data-lang="xml">    <span class="nt">&lt;servlet&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>ExampleRpc<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;servlet-class&gt;</span>pl.testing.server.ExampleRpcImpl<span class="nt">&lt;/servlet-class&gt;</span>
    <span class="nt">&lt;/servlet&gt;</span>
    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>ExampleRpc<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/pl.testing.Main/examplerpc<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>
</code></pre></div>
<p>Dzięki powyższemu zastąpieniu uzyskujemy zdecydowanie bardziej przyjazną konfigurację programiście. Dzięki temu rozwiązaniu możemy wykorzystać pełen potencjał naszego IDE i zapisywać bezbłędnie konfigurację przy pomocy autosugestii. W podobny sposób możemy nie tylko mapować serwlety, ale również i filtry. W praktyce większość konfiguracji może zostać przeniesiona z web.xml-a do odpowiednich modułów Guice-a. Na tym jednak nie koniec. Obecny stan wymaga podczas tworzenia połączenia GwtRpc następującego zapisu:</p>

<p>Część kliencka:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="nd">@RemoteServiceRelativePath</span><span class="o">(</span><span class="s">&quot;../examplerpc&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ExampleRpc</span> <span class="kd">extends</span> <span class="n">RemoteService</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">myMethod</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ExampleRpcAsync</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">myMethod</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">,</span> <span class="n">AsyncCallback</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">callback</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>
<p>I część serwerowa:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="nd">@Singleton</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExampleRpcImpl</span> <span class="kd">extends</span> <span class="n">RemoteServiceServlet</span> <span class="kd">implements</span> <span class="n">ExampleRpc</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">myMethod</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;Server says: &quot;</span> <span class="o">+</span> <span class="n">s</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>Jak widać w synchronicznym interfejsie nadal występuje niebezpieczeństwo pomyłki i konieczności zapamiętywania mapowania:
<code>@RemoteServiceRelativePath(“../examplerpc”)</code></p>

<p>Dzięki kolejnej sztuczce wyeliminujemy i ten “boilerplate code” – kod narażony/narażający na pomyłki. Dodajemy w części serwerowej klasę:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="nd">@Singleton</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GuiceRemoteServiceServlet</span> <span class="kd">extends</span> <span class="n">RemoteServiceServlet</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="n">Injector</span> <span class="n">injector</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">processCall</span><span class="o">(</span><span class="n">String</span> <span class="n">payload</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SerializationException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">RPCRequest</span> <span class="n">req</span> <span class="o">=</span> <span class="n">RPC</span><span class="o">.</span><span class="na">decodeRequest</span><span class="o">(</span><span class="n">payload</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
            <span class="n">RemoteService</span> <span class="n">service</span> <span class="o">=</span> <span class="o">(</span><span class="n">RemoteService</span><span class="o">)</span> <span class="n">injector</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">getDeclaringClass</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">RPC</span><span class="o">.</span><span class="na">invokeAndEncodeResponse</span><span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(),</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameters</span><span class="o">(),</span> <span class="n">req</span><span class="o">.</span><span class="na">getSerializationPolicy</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IncompatibleRemoteServiceException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">(</span><span class="s">&quot;IncompatibleRemoteServiceException in the processCall(String) method.&quot;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">RPC</span><span class="o">.</span><span class="na">encodeResponseForFailure</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>Jest to pośredniczący serwlet, dzięki któremu mapowanie urla na klasę serwleta zostanie zastąpione na bardzo dobrze znane i lubiane mapowanie konfiguracyjne tj. interfejsu na jego implementację. Rozwiązanie to zaproponował Eric Burke na łamach swojego bloga, które zdobyło ogromne uznanie wśród developerów GWT. W naszym przypadku osiągnęliśmy bardzo ciekawy efekt, mianowicie mapujemy interfej będący elementem części klienckiej na implementację serwerową.</p>

<p>Nasz plik konfiguracyjny w tym momencie wygląda następująco:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GuiceModule</span> <span class="kd">extends</span> <span class="n">ServletModule</span><span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configureServlets</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">configureServlets</span><span class="o">();</span>
        <span class="n">serve</span><span class="o">(</span><span class="s">&quot;/GWT.rpc&quot;</span><span class="o">).</span><span class="na">with</span><span class="o">(</span><span class="n">GuiceRemoteServiceServlet</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">bind</span><span class="o">(</span><span class="n">ExampleRpc</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">ExampleRpcImpl</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>Jak widać obsługujemy “/GWT.rpc” za pomocą GuiceRemoteServiceServlet.class, który jest tak naprawdę naszym dispatcherem, czyli klasą delegującą. Oznacza to, że GuiceRemoteServiceServlet.class kontroluje ruch. Gdy po stronie klienckiej zostanie wywołany serwlet za pomocą urla: “/GWT.rpc” zostanie wywołany właśnie nasz dispatcher. Wywołanie jest dekodowane:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="n">RPCRequest</span> <span class="n">req</span> <span class="o">=</span> <span class="n">RPC</span><span class="o">.</span><span class="na">decodeRequest</span><span class="o">(</span><span class="n">payload</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
</code></pre></div>
<p>a następnie pobierana jest klasa wywołująca servlet:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="n">req</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">getDeclaringClass</span><span class="o">()</span>
</code></pre></div>
<p>na podstawie której poprzez Injector otrzymujemy RemoteService, czyli klasę, z której musi dziedziczyć każdy servlet obsługujący GwtRPC. W naszym przypadku będzie to klasa, którą zbindowaliśmy z klasą wywołującą request. Dalsze linijki polegają na obsłudze samego wywołania oraz na zwróceniu odpowiedzi… ot i cała magia.
Należy pamiętać, że w części klienckiej będziemy używać teraz za każdym razem adnotacji aby wszystko chodziło jak należy:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="nd">@RemoteServiceRelativePath</span><span class="o">(</span><span class="s">&quot;../GWT.rpc&quot;</span><span class="o">)</span>
</code></pre></div>
<p>Dzięki zastosowaniu powyższej metody otrzymaliśmy mechanizm, który pozwoli na klarowne bo nie w xml-u oraz bezpieczne pisanie konfiguracji w oparciu o autosugestie. Ponadto jest on idealnym wstępem do stworzenia modularnej części serwerowej aplikacji wykorzystującej GWT, ale o tym dowiecie się z przyszłych postów.</p>

<p>Podsumowując konfigurację Guice-a powinniśmy otrzymać przykładowy zestaw klas po stronie klienckiej:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="nd">@RemoteServiceRelativePath</span><span class="o">(</span><span class="s">&quot;../GWT.rpc&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ExampleRpc</span> <span class="kd">extends</span> <span class="n">RemoteService</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">myMethod</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ExampleRpcAsync</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">myMethod</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">,</span> <span class="n">AsyncCallback</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">callback</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>
<p>oraz zestaw plików po stronie serwerowej:</p>

<p>web.xml:</p>
<div class="highlight"><pre><code class="xml language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;web-app</span> <span class="na">version=</span><span class="s">&quot;2.5&quot;</span> <span class="na">xmlns=</span><span class="s">&quot;http://java.sun.com/xml/ns/javaee&quot;</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;listener&gt;</span>
        <span class="nt">&lt;listener-class&gt;</span>pl.testing.server.GuiceConfig<span class="nt">&lt;/listener-class&gt;</span>
    <span class="nt">&lt;/listener&gt;</span>
    <span class="nt">&lt;filter&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>guiceFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;filter-class&gt;</span>com.google.inject.servlet.GuiceFilter<span class="nt">&lt;/filter-class&gt;</span>
    <span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;filter-mapping&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>guiceFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/filter-mapping&gt;</span>
    <span class="nt">&lt;session-config&gt;</span>
        <span class="nt">&lt;session-timeout&gt;</span>
            30
        <span class="nt">&lt;/session-timeout&gt;</span>
    <span class="nt">&lt;/session-config&gt;</span>
    <span class="nt">&lt;welcome-file-list&gt;</span>
        <span class="nt">&lt;welcome-file&gt;</span>welcomeGWT.html<span class="nt">&lt;/welcome-file&gt;</span>
    <span class="nt">&lt;/welcome-file-list&gt;</span>
<span class="nt">&lt;/web-app&gt;</span>
</code></pre></div><div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GuiceConfig</span> <span class="kd">extends</span> <span class="n">GuiceServletContextListener</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">Injector</span> <span class="nf">getInjector</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Guice</span><span class="o">.</span><span class="na">createInjector</span><span class="o">(</span><span class="k">new</span> <span class="n">GuiceModule</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GuiceModule</span> <span class="kd">extends</span> <span class="n">ServletModule</span><span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configureServlets</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">configureServlets</span><span class="o">();</span>
        <span class="n">serve</span><span class="o">(</span><span class="s">&quot;/GWT.rpc&quot;</span><span class="o">).</span><span class="na">with</span><span class="o">(</span><span class="n">GuiceRemoteServiceServlet</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">bind</span><span class="o">(</span><span class="n">ExampleRpc</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">ExampleRpcImpl</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExampleRpcImpl</span> <span class="kd">extends</span> <span class="n">RemoteServiceServlet</span> <span class="kd">implements</span> <span class="n">ExampleRpc</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">myMethod</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;Server says: &quot;</span> <span class="o">+</span> <span class="n">s</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Singleton</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GuiceRemoteServiceServlet</span> <span class="kd">extends</span> <span class="n">RemoteServiceServlet</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="n">Injector</span> <span class="n">injector</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">processCall</span><span class="o">(</span><span class="n">String</span> <span class="n">payload</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SerializationException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">RPCRequest</span> <span class="n">req</span> <span class="o">=</span> <span class="n">RPC</span><span class="o">.</span><span class="na">decodeRequest</span><span class="o">(</span><span class="n">payload</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
            <span class="n">RemoteService</span> <span class="n">service</span> <span class="o">=</span> <span class="o">(</span><span class="n">RemoteService</span><span class="o">)</span> <span class="n">injector</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">getDeclaringClass</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">RPC</span><span class="o">.</span><span class="na">invokeAndEncodeResponse</span><span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(),</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameters</span><span class="o">(),</span> <span class="n">req</span><span class="o">.</span><span class="na">getSerializationPolicy</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IncompatibleRemoteServiceException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">(</span><span class="s">&quot;IncompatibleRemoteServiceException in the processCall(String) method.&quot;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">RPC</span><span class="o">.</span><span class="na">encodeResponseForFailure</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>W tym miejscu zakończyliśmy konfigurację Guice-a wraz z GWT. W następnej części zajmiemy się obsługą Hibernate.</p>


	</div>
	<nav id="nav-bottom">
		
			<a href="/2014/02/01/gwt-basic-components.html" title="Older: Google Web Toolkit" class="btn btn-default">←</a>
		
			<a href="/blog" class="btn btn-default">Blog posts</a>
		
			<a href="/2014/02/03/hiberante-with-guice.html" title="Newer: Hibernate + Guice" class="btn btn-default">→</a>
		
	</nav>

	<footer id="comments">
		<header>
			<h1>Comments</h1>
		</header>
		<div id="disqus_thread"></div>
		<script type="text/javascript">
			var disqus_shortname = 'piotr-kosmowski-site'; // required: replace example with your forum shortname

			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>
		<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	</footer>

</article>
﻿<footer class="footer">
	<p>© Piotr Kosmowski. All right reserved. </p>
</footer>
		</div>
	</section>
  </body>
</html>