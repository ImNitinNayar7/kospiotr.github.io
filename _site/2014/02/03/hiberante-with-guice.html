<!DOCTYPE html>
<html lang="en">
  <head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="">
	<meta name="author" content="Piotr Kosmowski">
	<link rel="shortcut icon" href="favicon.ico">

	<title>Piotr Kosmowski page</title>

	<!-- Fonts -->
	<link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro%3A400%2C400italic%2C700" rel="stylesheet">
	<link href="http://fonts.googleapis.com/css?family=Varela+Round" rel="stylesheet">

	<!-- Bootstrap core CSS -->
	<link href="/css/bootstrap.min.css" rel="stylesheet">
	<link href="/css/font-awesome.min.css" rel="stylesheet">
	<link href="/css/bootstrap-social.css" rel="stylesheet">

	<!-- Styles -->
	<link href="/css/main.css" rel="stylesheet">

	<!-- Loading bar -->
	<script src="/js/jquery-1.10.2.min.js"></script>
	<script src="/js/jquery.stoc.js"></script>
	

	
	<!-- HTML5 shiv for IE8 support -->
	<!--[if lt IE 9]>
	  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
	<![endif]-->
  </head>

  <body>
	

	<section id="sidebar" class="col-sm-3 sidebar" style="display: inline-block;">
<header id="header">
	<a href="/">
	<img src="http://www.gravatar.com/avatar/a4e3f3d974bfdd573f2bb607617b82c1.png" alt="Piotr Kosmowski" id="gravatar"/>
	<p id="author-full-name">Piotr Kosmowski</p>
	<p id="slogan">Hi, I'm Piotr and I write code for food.</p>
</a>
</header>
<nav id="navigation">
	<div class="row">
		<a href="http://twitter.com/kospiotr" class="btn btn-default">Twitter</a>
		<a href="http://pl.linkedin.com/pub/piotr-kosmowski/25/379/467" class="btn btn-default">LinkedIn</a>
		<a href="/blog" class="btn btn-default">Blog</a>
	</div>
	<div class="row">	
		<a href="http://github.com/kospiotr" class="btn btn-default">Github</a>
		<a href="/wiki" class="btn btn-default">Wiki</a>
	</div>
</nav>
	</section>

	<section id="main" class="col-sm-9">
		<div id="main-container">
<article id="main-article">
	<header id="header">
		<nav id="nav">
			
				<a href="/2014/02/02/gwt-and-guice.html" title="Older: Google Web Toolkit + Guice" class="btn btn-default">←</a>
			
				<a href="/blog" class="btn btn-default">Blog posts</a>
			
				<a href="/2014/02/04/c3p0-proper-closing-application.html" title="Newer: C3P0 - poprawne zamykanie" class="btn btn-default">→</a>
			
		</nav>
		<h1 id="page-title">Hibernate + Guice</h1>
		
			<h2 id="page-description">
				Instalacja, konfiguracja oraz zestawienie z Guicem (in Polish)
			</h2>
		
		<h3> 03 Feb 2014</h3>
	</header>
	<div id="article-body" class="markdown-body">

<p>Hibernate – framework do realizacji warstwy dostępu do danych (ang. persistance layer). Zapewnia on przede wszystkim translację danych pomiędzy relacyjną bazą danych, a światem obiektowym (ang. O/R mapping). Opiera się na wykorzystaniu opisu struktury danych za pomocą języka XML, dzięki czemu można “rzutować” obiekty, stosowane w obiektowych językach programowania, takich jak Java bezpośrednio na istniejące tabele bazy danych. Dodatkowo Hibernate zwiększa wydajność operacji na bazie danych dzięki buforowaniu i minimalizacji liczby przesyłanych zapytań. Jest to projekt rozwijany jako open source. (wikipedia.pl)</p>

<p>Hibernate jest kolejnym wyborem naszych specjalistów w kwestii wyboru podstawowych komponentów do tworzenia aplikacji. Jest to najpopularniejszy, najbardziej zaawansowany ORM na rynku. Pomimo jego silnej pozycji chcemy zaznaczyć, że w bardziej zaawansowanych projektach dodatkowo posiłkujemy się MyBatisem, który stanowi doskonałe uzupełnienie bo raczej nie konkurencję :).</p>

<p>Kolejną kwestią, którą należy poruszyć jest to czy używać Hibernate bezpośrednio, czy jako dostawcy JPA. JPA jest jedynie standardem opisanym przez Sun-a i stanowi jedynie interfejs dostępu do danych. Oznacza to, że korzystając z interfejsów JPA podczas pobierania, wyszukiwania czy utrwalania obiektów korzystamy z interfejsu JPA. To co się faktycznie dzieje za kulisami, czyli w jaki sposób komunikacja z bazą się odbywa wykonuje już dostawca usługi ORM, czyli implementacja interfejsu JPA. Najpopularniejszymi implementacjami są: Hibernate, TopLink, Kodo, czy OpenJPA. Tak więc podczas pracy z bazą danych poprzez JPA nie musimy wiedzieć z jakiego mechanizmu obecnie korzystamy. Można to zobrazować do samochodu z silnikiem, bądź komputera i procesora. Silnik i procesor można wymienić na każdy inny pasujący do interfejsu. Nowe elementy spełniają identyczną rolę co ich poprzednicy natomiast swoim działaniem oraz efektami np mocy czy mocy obliczeniowej mogą się różnić od poprzedników. Z interfejsem JPA jest podobnie. JPA jest jak rama samochodu bądź gniazdo procesora – można do niego zainstalować elementy, które będą wykonywały określone czynności ale to urządzenie musi łączyć się ze środowiskiem zewnętrznym w okreslony przez interfejs sposób.
Jest to bardzo ciekawe rozwiązanie, które pozwoli na zastosowanie podzespołu według swoich preferencji. Dzięki wykorzystywaniu JPA w dowolnym momencie możemy wymienić Hibernate na np. TopLink-a. Rzeczywistość niestety nie jest taka różowa jakby się mogło wydawać. JPA jest specyfikacją, która oczywiście ulega ciągłym modyfikacjom (JPA 1.0 -&gt; JPA 2.0), jednak dostawcy ORM oprócz implementacji JPA znacznie poszerzają swoje możliwości idące daleko poza interfejs. Czynnikiem decydującym o rezygnacji z JPA była konfiguracja dostawcy, która nie mogła zostać zdefiniowana dynamicznie a tylko poprzez plik persistance.xml. Ponieważ dążymy do modułowej budowy aplikacji był to niezbędny element. Jako producenci płyty głównej zrezygnowaliśmy ze standardowego gniazda, przez które nie możemy obsłużyć dodatkowych 2 rdzeni procesora. Ponosimy ryzyko, że gdy będziemy chcieli zaktualizować Hibernate-a możemy napotkać problemy ze zgodnością niektórych klas, bądź obsłużyć w sposób wspomagany transakcję ale rzucając na szali liczne możliwości, ułatwienia oraz spełnienia wszystkich wymagań jakie stawialiśmy aplikacji decydujemy się zrezygnować z JPA.</p>

<p>Po nieco przydługawym wstępie pora rozpocząć prace z Hibernate. Jak wspomnieliśmy zależy nam na programowalnej konfiguracji a dokładniej na programowalnym dodawaniu plików z mapowaniami. W tym miejscu ponownie wyprzedzimy nieco wątek. Coraz popularniejszym sposobem definiowania mapowań czy to przez JPA czy przez dostawców jest umieszczanie adnotacji bezpośrednio w klasie domenowej co ma ułatwić, przyspieszyć pracę oraz zmniejszyć ilość kodu. Gdy konfigurowaliśmy Guice-a uciekaliśmy od xml-a właśnie w adnotacje tak tutaj niestety musimy zrobić krok w tył aby wyjść z zaułka do którego byśmy trafili zakładając dalsze wykorzystywanie w naszym projekcie GWT.
Podczas opisu frameworka GWT wspominaliśmy jakie ograniczenia są nałożone na warstwę kliencką. Klasy domenowe, które umieszczone są w części klienckiej mogą być wykorzystywane w części klienckiej, podczas transportowania danych między częścią kliencką a serwerową w mechaniźmie RPC oraz w części serwerowej. Dodając jednak adnotacje czy to Hibernate-owe, czy to JPA dodajemy fragmenty bibliotek niezgodnych z emulowanym środowiskiem GWT. Tym samym takich klas nie będziemy mogli wykorzystać ani w części klienckiej ani w transporcie GWT-RPC.
Jest to dość poważne ograniczenie ponieważ nie ma łatwego sposobu na obejście tego problemu. Jednym ze sposobów jest rezygnacja z adnotacji i wykorzystanie mapowań w XM-u, bądź można napisać klon naszej klasy domenowej, w niej dodać adnotacje a gdy zajdzie potrzeba przesłania danych czy to na stronę kliencką czy z klienckiej do bazy należałoby dane przekazać pomiędzy tymi plikami. Jest to podejście gdzie klon klasy domenowej wykorzystujący adnotacje nazywa się DTO. Istnieją oczywiście dodatkowe biblioteki takie jak Dozzer, które wspomagają pracę z DTO. Biblioteka ta na podstawie mapowania atrybutów jednej klasy do drugiej pozwala na niemal zautomatyzowany proces przepływu danych między obiektami. Niestety podejście DTO sprawia, że potrzebna jest masa dodatkowego kodu w którym również mogą pojawić się błędy a refaktoryzacja czy optymalizacja jest w tym przypadku niezwykle utrudniona, dlatego koncept adnotacji również został przez nas odrzucony. Więcej informacji na temat wspomnianych rozwiązań można znaleźć tu</p>

<p>Załóżmy, że będziemy uwierzytelniać następującą klasę domenową:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="n">String</span> <span class="n">login</span><span class="o">;</span>
    <span class="n">String</span> <span class="n">password</span><span class="o">;</span>
    <span class="n">String</span> <span class="n">displayName</span><span class="o">;</span>
    <span class="n">Date</span> <span class="n">registrationDate</span><span class="o">;</span>
    <span class="n">Date</span> <span class="n">lastLoginDate</span><span class="o">;</span>
    <span class="n">Integer</span> <span class="n">version</span><span class="o">;</span>

    <span class="c1">//getters and setters</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;Person{&quot;</span> <span class="o">+</span> <span class="s">&quot;id=&quot;</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span> <span class="s">&quot;,login=&quot;</span> <span class="o">+</span> <span class="n">login</span> <span class="o">+</span> <span class="s">&quot;,password=&quot;</span> <span class="o">+</span> <span class="n">password</span> <span class="o">+</span> <span class="s">&quot;,displayName=&quot;</span> <span class="o">+</span> <span class="n">displayName</span> <span class="o">+</span> <span class="s">&quot;,registrationDate=&quot;</span> <span class="o">+</span> <span class="n">registrationDate</span> <span class="o">+</span> <span class="s">&quot;,lastLoginDate=&quot;</span> <span class="o">+</span> <span class="n">lastLoginDate</span> <span class="o">+</span> <span class="s">&quot;,version=&quot;</span> <span class="o">+</span> <span class="n">version</span> <span class="o">+</span> <span class="sc">&#39;}&#39;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>Plik konfiguracyjny Hibernate będzie więc wyglądał następująco zakładając, że jako silnik bazy danych wykorzystamy Derby:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GuiceConfig</span> <span class="kd">extends</span> <span class="n">GuiceServletContextListener</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">contextInitialized</span><span class="o">(</span><span class="n">ServletContextEvent</span> <span class="n">servletContextEvent</span><span class="o">)</span> <span class="o">{</span>
       <span class="kd">super</span><span class="o">.</span><span class="na">contextInitialized</span><span class="o">(</span><span class="n">servletContextEvent</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">Injector</span> <span class="nf">getInjector</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Guice</span><span class="o">.</span><span class="na">createInjector</span><span class="o">(</span><span class="k">new</span> <span class="n">GuiceModule</span><span class="o">(),</span> <span class="k">new</span> <span class="n">HibernateModule</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
        <span class="n">Injector</span> <span class="n">injector</span> <span class="o">=</span> <span class="n">Guice</span><span class="o">.</span><span class="na">createInjector</span><span class="o">(</span><span class="k">new</span> <span class="n">GuiceModule</span><span class="o">(),</span> <span class="k">new</span> <span class="n">HibernateModule</span><span class="o">());</span>
        <span class="n">SessionFactory</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">SessionFactory</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HibernateModule</span> <span class="kd">extends</span> <span class="n">AbstractModule</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
       <span class="n">bind</span><span class="o">(</span><span class="n">SessionFactory</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">toProvider</span><span class="o">(</span><span class="n">HibernateSessionFactoryProvider</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">in</span><span class="o">(</span><span class="n">Singleton</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">HibernateSessionFactoryProvider</span> <span class="kd">implements</span> <span class="n">Provider</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="n">SessionFactory</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Configuration</span> <span class="n">configuration</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Configuration</span><span class="o">();</span>
        <span class="n">configuration</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;hibernate.dialect&quot;</span><span class="o">,</span> <span class="s">&quot;org.hibernate.dialect.DerbyDialect&quot;</span><span class="o">);</span>
        <span class="n">configuration</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;hibernate.connection.driver_class&quot;</span><span class="o">,</span> <span class="s">&quot;org.apache.derby.jdbc.ClientDriver&quot;</span><span class="o">);</span>
        <span class="n">configuration</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;hibernate.connection.url&quot;</span><span class="o">,</span> <span class="s">&quot;jdbc:derby://localhost:1527/sample&quot;</span><span class="o">);</span>
        <span class="n">configuration</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;hibernate.connection.username&quot;</span><span class="o">,</span> <span class="s">&quot;app&quot;</span><span class="o">);</span>
        <span class="n">configuration</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;hibernate.connection.password&quot;</span><span class="o">,</span> <span class="s">&quot;app&quot;</span><span class="o">);</span>
        <span class="n">configuration</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;hibernate.current_session_context_class&quot;</span><span class="o">,</span> <span class="s">&quot;thread&quot;</span><span class="o">);</span>
        <span class="n">configuration</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;hibernate.cache.provider_class&quot;</span><span class="o">,</span> <span class="s">&quot;org.hibernate.cache.NoCacheProvider&quot;</span><span class="o">);</span>
        <span class="n">configuration</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;hibernate.show_sql&quot;</span><span class="o">,</span> <span class="s">&quot;true&quot;</span><span class="o">);</span>
        <span class="n">configuration</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;hibernate.hbm2ddl.auto&quot;</span><span class="o">,</span> <span class="s">&quot;create-drop&quot;</span><span class="o">);</span>

        <span class="n">configuration</span><span class="o">.</span><span class="na">addClass</span><span class="o">(</span><span class="n">Person</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="n">SessionFactory</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="na">buildSessionFactory</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">sf</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>Razem z modułem naszej aplikacji dodajemy moduł, dzięki któremu dodamy obsługę bazy danych. Moduł ten umożliwia wstrzyknięcie w dowolne miejsce aplikacji implementacji SessionFactory, która w tym przypadku jest dostarczana przez Providera. Kod możemy przetestować bez konieczności uruchamiania serwera za pomocą pseudo klasy testującej:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testingHibernateModule</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Injector</span> <span class="n">injector</span> <span class="o">=</span> <span class="n">Guice</span><span class="o">.</span><span class="na">createInjector</span><span class="o">(</span><span class="k">new</span> <span class="n">GuiceModule</span><span class="o">(),</span> <span class="k">new</span> <span class="n">HibernateModule</span><span class="o">());</span>
    <span class="n">SessionFactory</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">SessionFactory</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>
<p>Podczas uruchamiania zostanie rzucony następujący błąd:
<code>“Error in custom provider, org.hibernate.MappingNotFoundException: resource: pl/testing/client/Person.hbm.xml not found”</code>, który oznacza, że brakuje pliku mapującego.</p>

<p>Gdy konfigurowaliśmy Hibernate-a w linijce:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="n">configuration</span><span class="o">.</span><span class="na">addClass</span><span class="o">(</span><span class="n">Person</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div>
<p>przyjęliśmy, że będziemy korzystać z klasy Person a zgodnie z manualem: Programmatic configuration przy zastosowaniu takiej konfiguracji będzie wymagany plik mapujący nazywający się tak jak klasa i znajdujący się w tej samej lokalizacji (paczce) co klasa mapowana:</p>
<div class="highlight"><pre><code class="xml language-xml" data-lang="xml"><span class="c">&lt;!--?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?--&gt;</span>
</code></pre></div>
<p>Po dodaniu pliku mapującego i uruchomieniu metody testującej schemat naszej bazy zostanie zaktualizowany a środowisko gotowe do wykorzystywania w modułowej aplikacji internetowej.</p>


	</div>
	<nav id="nav-bottom">
		
			<a href="/2014/02/02/gwt-and-guice.html" title="Older: Google Web Toolkit + Guice" class="btn btn-default">←</a>
		
			<a href="/blog" class="btn btn-default">Blog posts</a>
		
			<a href="/2014/02/04/c3p0-proper-closing-application.html" title="Newer: C3P0 - poprawne zamykanie" class="btn btn-default">→</a>
		
	</nav>

	<footer id="comments">
		<header>
			<h1>Comments</h1>
		</header>
		<div id="disqus_thread"></div>
		<script type="text/javascript">
			var disqus_shortname = 'piotr-kosmowski-site'; // required: replace example with your forum shortname

			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>
		<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	</footer>

</article>
﻿<footer class="footer">
	<p>© Piotr Kosmowski. All right reserved. </p>
</footer>
		</div>
	</section>
  </body>
</html>